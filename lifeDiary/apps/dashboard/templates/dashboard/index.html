{% extends 'base.html' %}

{% block title %}ëŒ€ì‹œë³´ë“œ - {{ selected_date|date:"Yë…„ mì›” dì¼" }} | ë¼ì´í”„ ë‹¤ì´ì–´ë¦¬{% endblock %}

{% block content %}
<div class="row">
    <!-- ë‚ ì§œ ì„ íƒ ë° í†µê³„ -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-calendar-day me-2"></i>
                    {{ selected_date|date:"Yë…„ mì›” dì¼ (l)" }}
                </h5>
                <div class="d-flex gap-2">
                    <input type="date" 
                           class="form-control form-control-sm" 
                           id="dateSelector" 
                           value="{{ selected_date|date:'Y-m-d' }}"
                           style="width: 150px;">
                    <button class="btn btn-sm btn-outline-primary" onclick="goToToday()">
                        <i class="fas fa-home"></i> ì˜¤ëŠ˜
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <div class="d-flex align-items-center justify-content-center">
                            <i class="fas fa-clock text-primary me-2"></i>
                            <div>
                                <div class="fw-bold">{{ total_slots }}</div>
                                <small class="text-muted">ì´ ìŠ¬ë¡¯</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-flex align-items-center justify-content-center">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            <div>
                                <div class="fw-bold">{{ filled_slots }}</div>
                                <small class="text-muted">ê¸°ë¡ëœ ìŠ¬ë¡¯</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-flex align-items-center justify-content-center">
                            <i class="fas fa-chart-pie text-info me-2"></i>
                            <div>
                                <div class="fw-bold">{{ fill_percentage }}%</div>
                                <small class="text-muted">ê¸°ë¡ë¥ </small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-flex align-items-center justify-content-center">
                            <i class="fas fa-hourglass-half text-warning me-2"></i>
                            <div>
                                <div class="fw-bold">{{ total_hours }}ì‹œê°„ {{ remaining_minutes }}ë¶„</div>
                                <small class="text-muted">ì´ ê¸°ë¡ ì‹œê°„</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- ì‹œê°„ ê·¸ë¦¬ë“œ -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-th me-2"></i>
                    ì‹œê°„ ê·¸ë¦¬ë“œ (10ë¶„ ë‹¨ìœ„)
                </h6>
            </div>
            <div class="card-body">
                <!-- ì‹œê°„ í‘œì‹œ í—¤ë” (ê·¸ë¦¬ë“œì™€ ë™ì¼í•œ 12ì—´ êµ¬ì¡°) -->
                <div class="time-grid mb-3" style="grid-template-columns: repeat(12, 1fr); display: grid; gap: 2px;">
                    {% for time_header in time_headers %}
                        <div class="text-center text-muted small py-1" style="font-weight: 500;">
                            {{ time_header }}
                        </div>
                    {% endfor %}
                </div>
                
                <!-- 144ì¹¸ ê·¸ë¦¬ë“œ -->
                <div class="time-grid" id="timeGrid">
                    {% for slot in slots %}
                        <div class="time-slot {% if slot.data %}filled{% endif %}" 
                             data-slot-index="{{ slot.index }}"
                             data-time="{{ slot.time_str }}"
                             {% if slot.data %}
                                 style="background-color: {{ slot.data.tag.color }};"
                                 title="{{ slot.time_str }} - {{ slot.data.tag.name }}{% if slot.data.memo %}: {{ slot.data.memo }}{% endif %}"
                             {% else %}
                                 title="{{ slot.time_str }} - ë¹ˆ ìŠ¬ë¡¯"
                             {% endif %}
                             onclick="selectSlot({{ slot.index }})"
                             onmousedown="startDrag({{ slot.index }})"
                             onmouseenter="dragOver({{ slot.index }})"
                             onmouseup="endDrag()"
                             ontouchstart="startDrag({{ slot.index }})"
                             ontouchmove="handleTouchMove(event)"
                             ontouchend="endDrag()">
                            
                            <!-- ì‹œê°„ í‘œì‹œ (ë§¤ ì‹œê°„ë§ˆë‹¤) -->
                            {% if slot.minute == 0 %}
                                <div class="slot-time">{{ slot.hour|stringformat:"02d" }}:00</div>
                            {% endif %}
                            
                            <!-- íƒœê·¸ í‘œì‹œ -->
                            {% if slot.data %}
                                <div class="position-absolute w-100 h-100 d-flex align-items-center justify-content-center">
                                    <small class="text-white fw-bold" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">
                                        {{ slot.data.tag.name|truncatechars:3 }}
                                    </small>
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
                
                <!-- ë²”ë¡€ -->
                <div class="mt-3">
                    <div class="d-flex flex-wrap gap-2" id="tagLegend">
                        <div class="spinner-border spinner-border-sm text-secondary" role="status">
                            <span class="visually-hidden">ë²”ë¡€ ë¡œë”© ì¤‘...</span>
                        </div>
                        <small class="text-muted">ë²”ë¡€ ë¡œë”© ì¤‘...</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ì‚¬ì´ë“œë°” - íƒœê·¸ ì„ íƒ ë° ì •ë³´ -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-edit me-2"></i>
                    ë¹ ë¥¸ ì…ë ¥
                </h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label class="form-label mb-0">íƒœê·¸ ì„ íƒ</label>
                        <div>
                            <button type="button" class="btn btn-sm btn-outline-success me-1" id="createNewTagBtn">
                                <i class="fas fa-plus"></i> ìƒˆ íƒœê·¸
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-primary me-1" id="manageTagsBtn">
                                <i class="fas fa-cog"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="collapse" data-bs-target="#usageHelp" aria-expanded="false" aria-controls="usageHelp">
                                <i class="fas fa-question-circle"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="collapse" id="usageHelp" data-bs-parent="">
                        <div class="card border-info mt-2">
                            <div class="card-body bg-light py-2">
                                <small class="text-info">
                                    <i class="fas fa-info-circle me-1"></i><strong>ì‚¬ìš©ë²•:</strong><br>
                                    â€¢ <strong>ë‹¨ì¼ ì„ íƒ:</strong> ìŠ¬ë¡¯ í´ë¦­<br>
                                    â€¢ <strong>ë“œë˜ê·¸ ì„ íƒ:</strong> ë§ˆìš°ìŠ¤ë¡œ ë“œë˜ê·¸<br>
                                    â€¢ <strong>ë‹¤ì¤‘ ì„ íƒ:</strong> Ctrl/Cmd + í´ë¦­<br>
                                    â€¢ <strong>í„°ì¹˜:</strong> í„°ì¹˜ í›„ ë“œë˜ê·¸<br><br>
                                    <small class="text-muted">ğŸ’¡ ì´ ë„ì›€ë§ì€ ? ë²„íŠ¼ì„ ë‹¤ì‹œ í´ë¦­í•˜ë©´ ë‹«í™ë‹ˆë‹¤.</small>
                                </small>
                            </div>
                        </div>
                        </div>
                    </div>
                    
                    <!-- íƒœê·¸ ëª©ë¡ì´ ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
                    <div class="d-grid gap-2" id="tagContainer">
                        <div class="text-center py-3">
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                <span class="visually-hidden">íƒœê·¸ ë¡œë”© ì¤‘...</span>
                            </div>
                            <div class="mt-2 text-muted small">íƒœê·¸ ë¡œë”© ì¤‘...</div>
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="memoInput" class="form-label">ë©”ëª¨ (ì„ íƒì‚¬í•­)</label>
                    <textarea class="form-control" id="memoInput" rows="3" placeholder="ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                </div>
                
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" onclick="saveSlot()" disabled id="saveBtn">
                        <i class="fas fa-save me-1"></i>
                        ì €ì¥
                    </button>
                    <button class="btn btn-outline-danger" onclick="deleteSlot()" disabled id="deleteBtn">
                        <i class="fas fa-trash me-1"></i>
                        ì‚­ì œ
                    </button>
                </div>
            </div>
        </div>
        
        <!-- ì„ íƒëœ ìŠ¬ë¡¯ ì •ë³´ -->
        <div class="card mt-3" id="slotInfoCard" style="display: none;">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    ì„ íƒëœ ìŠ¬ë¡¯
                </h6>
            </div>
            <div class="card-body">
                <div id="slotInfo">
                    <!-- JavaScriptë¡œ ë™ì  ì—…ë°ì´íŠ¸ -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ëª¨ë‹¬ë“¤ (endblock ì•ˆìœ¼ë¡œ ì´ë™) -->
<!-- íƒœê·¸ ê´€ë¦¬ ëª¨ë‹¬ -->
<div class="modal fade" id="tagManageModal" tabindex="-1" aria-labelledby="tagManageModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="tagManageModalLabel">
                    <i class="fas fa-tags me-2"></i>íƒœê·¸ ê´€ë¦¬
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- ìƒˆ íƒœê·¸ ìƒì„± -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-plus me-2"></i>ìƒˆ íƒœê·¸ ë§Œë“¤ê¸°</h6>
                    </div>
                    <div class="card-body">
                        <form id="createTagForm">
                            <div class="mb-3">
                                <label for="newTagName" class="form-label">íƒœê·¸ëª…</label>
                                <input type="text" class="form-control" id="newTagName" placeholder="ì˜ˆ: ìš´ë™, ê³µë¶€, íœ´ì‹">
                            </div>
                            <div class="mb-3">
                                <label for="newTagColor" class="form-label">ìƒ‰ìƒ</label>
                                <div class="d-flex align-items-center gap-2">
                                    <input type="color" class="form-control form-control-color" id="newTagColor" value="#3498db">
                                    <input type="text" class="form-control" id="newTagColorText" placeholder="#3498db" maxlength="7">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-plus me-1"></i>íƒœê·¸ ìƒì„±
                            </button>
                        </form>
                    </div>
                </div>

                <!-- ê¸°ì¡´ íƒœê·¸ ëª©ë¡ -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-list me-2"></i>ë‚´ íƒœê·¸ ëª©ë¡</h6>
                    </div>
                    <div class="card-body">
                        <div id="tagList">
                            <!-- JavaScriptë¡œ ë™ì  ë¡œë“œ -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
</div>

<!-- íƒœê·¸ í¸ì§‘ ëª¨ë‹¬ -->
<div class="modal fade" id="tagEditModal" tabindex="-1" aria-labelledby="tagEditModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="tagEditModalLabel">
                    <i class="fas fa-edit me-2"></i>íƒœê·¸ í¸ì§‘
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editTagForm">
                    <input type="hidden" id="editTagId">
                    <div class="mb-3">
                        <label for="editTagName" class="form-label">íƒœê·¸ëª…</label>
                        <input type="text" class="form-control" id="editTagName">
                    </div>
                    <div class="mb-3">
                        <label for="editTagColor" class="form-label">ìƒ‰ìƒ</label>
                        <div class="d-flex align-items-center gap-2">
                            <input type="color" class="form-control form-control-color" id="editTagColor">
                            <input type="text" class="form-control" id="editTagColorText" maxlength="7">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-primary" id="saveTagBtn">
                    <i class="fas fa-save me-1"></i>ì €ì¥
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    let selectedSlots = new Set(); // ì„ íƒëœ ìŠ¬ë¡¯ë“¤ì„ ì €ì¥í•˜ëŠ” Set
    let selectedTag = null;
    let isDragging = false;
    let startSlot = null;
    let availableTags = []; // ì‚¬ìš© ê°€ëŠ¥í•œ íƒœê·¸ ëª©ë¡
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ íƒœê·¸ ëª©ë¡ ë¡œë“œ ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM ë¡œë“œ ì™„ë£Œ - ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì‹œì‘');
        
        // Bootstrap ë¡œë“œ í™•ì¸
        if (typeof bootstrap === 'undefined') {
            console.warn('Bootstrapì´ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. 0.5ì´ˆ í›„ ì¬ì‹œë„í•©ë‹ˆë‹¤.');
            setTimeout(() => {
                if (typeof bootstrap !== 'undefined') {
                    console.log('Bootstrap ë¡œë“œ ì™„ë£Œ');
                } else {
                    console.error('Bootstrap ë¡œë“œ ì‹¤íŒ¨ - ëª¨ë‹¬ ê¸°ëŠ¥ì´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                }
            }, 500);
        } else {
            console.log('Bootstrap ë¡œë“œ í™•ì¸ë¨');
        }
        
        // ë²„íŠ¼ ì¡´ì¬ í™•ì¸
        const createBtn = document.getElementById('createNewTagBtn');
        const manageBtn = document.getElementById('manageTagsBtn');
        
        console.log('createNewTagBtn ì°¾ìŒ:', !!createBtn);
        console.log('manageTagsBtn ì°¾ìŒ:', !!manageBtn);
        
        loadAvailableTags();
        
        // ë‚ ì§œ ë³€ê²½ - í˜„ëŒ€ì ì¸ ë°©ì‹
        const dateSelector = document.getElementById('dateSelector');
        if (dateSelector) {
            dateSelector.addEventListener('change', (event) => {
                const selectedDate = event.target.value;
                const url = new URL(window.location);
                url.searchParams.set('date', selectedDate);
                window.location.href = url.toString();
            });
        }
        
        // ìƒˆ íƒœê·¸ ë§Œë“¤ê¸° ë²„íŠ¼ (addEventListenerë§Œ ì‚¬ìš©)
        if (createBtn) {
            createBtn.addEventListener('click', function() {
                console.log('ğŸš€ ìƒˆ íƒœê·¸ ë²„íŠ¼ í´ë¦­ë¨ (addEventListener)');
                if (window.openCreateTagModal) {
                    window.openCreateTagModal();
                }
            });
            console.log('ìƒˆ íƒœê·¸ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì™„ë£Œ');
        }

        // íƒœê·¸ ê´€ë¦¬ ëª¨ë‹¬ ì—´ê¸° (addEventListenerë§Œ ì‚¬ìš©)
        if (manageBtn) {
            manageBtn.addEventListener('click', function() {
                console.log('ğŸš€ íƒœê·¸ ê´€ë¦¬ ë²„íŠ¼ í´ë¦­ë¨ (addEventListener)');
                if (window.openManageTagModal) {
                    window.openManageTagModal();
                }
            });
            console.log('íƒœê·¸ ê´€ë¦¬ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì™„ë£Œ');
        }

        // ìƒ‰ìƒ ì…ë ¥ ë™ê¸°í™”
        const newTagColor = document.getElementById('newTagColor');
        const newTagColorText = document.getElementById('newTagColorText');
        const editTagColor = document.getElementById('editTagColor');
        const editTagColorText = document.getElementById('editTagColorText');
        
        if (newTagColor && newTagColorText) {
            newTagColor.addEventListener('input', function() {
                newTagColorText.value = this.value;
            });
            
            newTagColorText.addEventListener('input', function() {
                if (this.value.match(/^#[0-9A-Fa-f]{6}$/)) {
                    newTagColor.value = this.value;
                }
            });
        }

        if (editTagColor && editTagColorText) {
            editTagColor.addEventListener('input', function() {
                editTagColorText.value = this.value;
            });
            
            editTagColorText.addEventListener('input', function() {
                if (this.value.match(/^#[0-9A-Fa-f]{6}$/)) {
                    editTagColor.value = this.value;
                }
            });
        }

        // ìƒˆ íƒœê·¸ ìƒì„± í¼
        const createTagForm = document.getElementById('createTagForm');
        if (createTagForm) {
            createTagForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                console.log('ìƒˆ íƒœê·¸ ìƒì„± í¼ ì œì¶œë¨');
                
                const nameInput = document.getElementById('newTagName');
                const colorInput = document.getElementById('newTagColor');
                
                if (!nameInput || !colorInput) {
                    alert('í¼ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                const name = nameInput.value.trim();
                const color = colorInput.value;
                
                if (!name) {
                    alert('íƒœê·¸ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                try {
                    const response = await fetch('/dashboard/api/tags/create/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({ name, color })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // í¼ ì´ˆê¸°í™”
                        nameInput.value = '';
                        colorInput.value = '#3498db';
                        if (newTagColorText) newTagColorText.value = '#3498db';
                        
                        // íƒœê·¸ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                        if (window.loadTagList) loadTagList();
                        
                        // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ (alert ëŒ€ì‹  console.log)
                        console.log('íƒœê·¸ ìƒì„± ì„±ê³µ:', result.message);
                        
                        // ë©”ì¸ í˜ì´ì§€ì˜ íƒœê·¸ ëª©ë¡ë„ ìƒˆë¡œê³ ì¹¨
                        refreshTagList();
                        
                        // ì„±ê³µ í‘œì‹œë¥¼ ìœ„í•œ ì‹œê°ì  í”¼ë“œë°±
                        const createForm = document.getElementById('createTagForm');
                        if (createForm) {
                            createForm.style.border = '2px solid #28a745';
                            setTimeout(() => {
                                createForm.style.border = '';
                            }, 2000);
                        }
                    } else {
                        alert(result.message);
                    }
                } catch (error) {
                    console.error('íƒœê·¸ ìƒì„± ì˜¤ë¥˜:', error);
                    alert('íƒœê·¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            });
            console.log('ìƒˆ íƒœê·¸ ìƒì„± í¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì™„ë£Œ');
        }

        // íƒœê·¸ ì €ì¥ (í¸ì§‘)
        const saveTagBtn = document.getElementById('saveTagBtn');
        if (saveTagBtn) {
            saveTagBtn.addEventListener('click', async function() {
                console.log('íƒœê·¸ ì €ì¥ ë²„íŠ¼ í´ë¦­ë¨');
                
                const tagIdInput = document.getElementById('editTagId');
                const nameInput = document.getElementById('editTagName');
                const colorInput = document.getElementById('editTagColor');
                
                if (!tagIdInput || !nameInput || !colorInput) {
                    alert('í¸ì§‘ í¼ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                const tagId = tagIdInput.value;
                const name = nameInput.value.trim();
                const color = colorInput.value;
                
                if (!name) {
                    alert('íƒœê·¸ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                try {
                    const response = await fetch(`/dashboard/api/tags/${tagId}/update/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({ name, color })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // íƒœê·¸ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                        if (window.loadTagList) loadTagList();
                        
                        // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ (alert ëŒ€ì‹  console.log)
                        console.log('íƒœê·¸ ìˆ˜ì • ì„±ê³µ:', result.message);
                        
                        // ë©”ì¸ í˜ì´ì§€ì˜ íƒœê·¸ ëª©ë¡ë„ ìƒˆë¡œê³ ì¹¨
                        refreshTagList();
                        
                        // ì„±ê³µ í‘œì‹œë¥¼ ìœ„í•œ ì‹œê°ì  í”¼ë“œë°±
                        const editForm = document.getElementById('editTagForm');
                        if (editForm) {
                            editForm.style.border = '2px solid #28a745';
                            setTimeout(() => {
                                editForm.style.border = '';
                            }, 2000);
                        }
                        
                        // 3ì´ˆ í›„ ìë™ìœ¼ë¡œ ëª¨ë‹¬ ë‹«ê¸° (ì‚¬ìš©ìê°€ í™•ì¸í•  ì‹œê°„ ì œê³µ)
                        setTimeout(() => {
                            const editModal = document.getElementById('tagEditModal');
                            if (editModal) {
                                const modalInstance = bootstrap.Modal.getInstance(editModal);
                                if (modalInstance) modalInstance.hide();
                            }
                        }, 2000);
                    } else {
                        alert(result.message);
                    }
                } catch (error) {
                    console.error('íƒœê·¸ ìˆ˜ì • ì˜¤ë¥˜:', error);
                    alert('íƒœê·¸ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            });
            console.log('íƒœê·¸ ì €ì¥ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì™„ë£Œ');
        }
        
        console.log('ëª¨ë“  ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì™„ë£Œ');
    });
    
    // ì•ˆì „í•œ ëª¨ë‹¬ ìƒì„± í•¨ìˆ˜ (ê°œì„ ëœ ë²„ì „)
    function createSafeModal(modalId) {
        return new Promise((resolve) => {
            // DOMì´ ì™„ì „íˆ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
            if (document.readyState !== 'complete') {
                console.log('DOMì´ ì•„ì§ ì™„ì „íˆ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ ê¸°ë‹¤ë¦½ë‹ˆë‹¤...');
                setTimeout(() => {
                    resolve(createSafeModal(modalId));
                }, 100);
                return;
            }
            
            // Bootstrapì´ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
            if (typeof bootstrap === 'undefined') {
                console.error('Bootstrapì´ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                alert('í˜ì´ì§€ê°€ ì™„ì „íˆ ë¡œë“œë  ë•Œê¹Œì§€ ì ì‹œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.');
                resolve(null);
                return;
            }
            
            // ëª¨ë‹¬ ìš”ì†Œ í™•ì¸ (ìµœëŒ€ 5ì´ˆ ë™ì•ˆ ì¬ì‹œë„)
            let attempts = 0;
            const maxAttempts = 50; // 5ì´ˆ
            
            const findModal = () => {
                const modalElement = document.getElementById(modalId);
                
                if (modalElement) {
                    console.log(`ëª¨ë‹¬ ìš”ì†Œ ì°¾ìŒ: ${modalId}`);
                    
                    try {
                        // ê¸°ì¡´ ëª¨ë‹¬ ì¸ìŠ¤í„´ìŠ¤ê°€ ìˆë‹¤ë©´ ì œê±°
                        const existingModal = bootstrap.Modal.getInstance(modalElement);
                        if (existingModal) {
                            existingModal.dispose();
                        }
                        
                        // ìƒˆ ëª¨ë‹¬ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
                        const modal = new bootstrap.Modal(modalElement, {
                            backdrop: true,
                            keyboard: true,
                            focus: true
                        });
                        
                        resolve(modal);
                    } catch (error) {
                        console.error('ëª¨ë‹¬ ìƒì„± ì¤‘ ì˜¤ë¥˜:', error);
                        resolve(null);
                    }
                } else {
                    attempts++;
                    if (attempts < maxAttempts) {
                        console.log(`ëª¨ë‹¬ ìš”ì†Œë¥¼ ì°¾ëŠ” ì¤‘... (${attempts}/${maxAttempts})`);
                        setTimeout(findModal, 100);
                    } else {
                        console.error(`ëª¨ë‹¬ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${modalId} (${maxAttempts}ë²ˆ ì‹œë„ í›„ í¬ê¸°)`);
                        alert('ëª¨ë‹¬ì„ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ë³´ì„¸ìš”.');
                        resolve(null);
                    }
                }
            };
            
            findModal();
        });
    }

    // ì „ì—­ í•¨ìˆ˜ë“¤ (onclick ì´ë²¤íŠ¸ìš©) - Promise ë°©ì‹ìœ¼ë¡œ ì—…ë°ì´íŠ¸
    window.openCreateTagModal = async function() {
        console.log('ğŸ”¥ openCreateTagModal í˜¸ì¶œë¨ - í˜¸ì¶œ ìŠ¤íƒ:', new Error().stack);
        
        try {
            const modal = await createSafeModal('tagManageModal');
            if (!modal) {
                console.error('ëª¨ë‹¬ ìƒì„± ì‹¤íŒ¨');
                return;
            }
            
            const modalElement = document.getElementById('tagManageModal');
            if (!modalElement) {
                console.error('ëª¨ë‹¬ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            // ëª¨ë‹¬ì´ ì™„ì „íˆ ì—´ë¦° í›„ ì‹¤í–‰
            modalElement.addEventListener('shown.bs.modal', function() {
                console.log('ëª¨ë‹¬ì´ ì™„ì „íˆ ì—´ë¦¼ - íƒœê·¸ ëª©ë¡ ë¡œë“œ ì‹œì‘');
                if (window.loadTagList) loadTagList();
                
                // ìƒˆ íƒœê·¸ ì´ë¦„ ì…ë ¥ë€ì— í¬ì»¤ìŠ¤
                setTimeout(() => {
                    const nameInput = document.getElementById('newTagName');
                    if (nameInput) nameInput.focus();
                }, 100);
            }, { once: true }); // í•œ ë²ˆë§Œ ì‹¤í–‰
            
            modal.show();
        } catch (error) {
            console.error('ëª¨ë‹¬ ì—´ê¸° ì¤‘ ì˜¤ë¥˜:', error);
            alert('ëª¨ë‹¬ì„ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ë³´ì„¸ìš”.');
        }
    };
    
    window.openManageTagModal = async function() {
        console.log('ğŸ”¥ openManageTagModal í˜¸ì¶œë¨ - í˜¸ì¶œ ìŠ¤íƒ:', new Error().stack);
        
        try {
            const modal = await createSafeModal('tagManageModal');
            if (!modal) {
                console.error('ëª¨ë‹¬ ìƒì„± ì‹¤íŒ¨');
                return;
            }
            
            const modalElement = document.getElementById('tagManageModal');
            if (!modalElement) {
                console.error('ëª¨ë‹¬ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            // ëª¨ë‹¬ì´ ì™„ì „íˆ ì—´ë¦° í›„ ì‹¤í–‰
            modalElement.addEventListener('shown.bs.modal', function() {
                console.log('ëª¨ë‹¬ì´ ì™„ì „íˆ ì—´ë¦¼ - íƒœê·¸ ëª©ë¡ ë¡œë“œ ì‹œì‘');
                if (window.loadTagList) loadTagList();
            }, { once: true }); // í•œ ë²ˆë§Œ ì‹¤í–‰
            
            modal.show();
        } catch (error) {
            console.error('ëª¨ë‹¬ ì—´ê¸° ì¤‘ ì˜¤ë¥˜:', error);
            alert('ëª¨ë‹¬ì„ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ë³´ì„¸ìš”.');
        }
    };

    // íƒœê·¸ ëª©ë¡ ë¡œë“œ í•¨ìˆ˜ (ì „ì—­ í•¨ìˆ˜ë¡œ ì¶”ê°€)
    window.loadTagList = async function loadTagList() {
        console.log('íƒœê·¸ ëª©ë¡ ë¡œë“œ ì‹œì‘');
        
        const tagListElement = document.getElementById('tagList');
        if (!tagListElement) {
            console.error('tagList ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ëª¨ë‹¬ì´ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            return;
        }
        
        try {
            const response = await fetch('/dashboard/api/tags/');
            const result = await response.json();
            
            console.log('íƒœê·¸ API ì‘ë‹µ:', result);
            
            if (result.success) {
                renderTagList(result.tags);
                console.log('íƒœê·¸ ëª©ë¡ ë Œë”ë§ ì™„ë£Œ');
            } else {
                tagListElement.innerHTML = 
                    `<div class="alert alert-danger">íƒœê·¸ ë¡œë“œ ì‹¤íŒ¨: ${result.message}</div>`;
            }
        } catch (error) {
            console.error('íƒœê·¸ ë¡œë“œ ì˜¤ë¥˜:', error);
            if (tagListElement) {
                tagListElement.innerHTML = 
                    '<div class="alert alert-danger">íƒœê·¸ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
            }
        }
    };

    // íƒœê·¸ ëª©ë¡ ë Œë”ë§ í•¨ìˆ˜
    function renderTagList(tags) {
        const tagList = document.getElementById('tagList');
        
        if (!tagList) {
            console.error('tagList ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ëª¨ë‹¬ì´ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            return;
        }
        
        if (tags.length === 0) {
            tagList.innerHTML = '<p class="text-muted">ë“±ë¡ëœ íƒœê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }
        
        let html = '';
        tags.forEach(tag => {
            html += `
                <div class="d-flex align-items-center justify-content-between mb-2 p-2 border rounded">
                    <div class="d-flex align-items-center">
                        <span class="badge me-2" style="background-color: ${tag.color};">&nbsp;</span>
                        <span>${tag.name}</span>
                        ${tag.is_default ? '<small class="text-muted ms-2">(ê¸°ë³¸ íƒœê·¸)</small>' : ''}
                    </div>
                    <div>
                        ${tag.can_edit ? `
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editTag(${tag.id}, '${tag.name}', '${tag.color}')">
                                <i class="fas fa-edit"></i>
                            </button>
                        ` : ''}
                        ${tag.can_delete ? `
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteTag(${tag.id}, '${tag.name}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        });
        
        tagList.innerHTML = html;
    }

    // íƒœê·¸ í¸ì§‘ ëª¨ë‹¬ ì—´ê¸° (ì „ì—­ í•¨ìˆ˜ë¡œ ì¶”ê°€) - Promise ë°©ì‹ìœ¼ë¡œ ì—…ë°ì´íŠ¸
    window.editTag = async function editTag(tagId, tagName, tagColor) {
        try {
            const editTagIdInput = document.getElementById('editTagId');
            const editTagNameInput = document.getElementById('editTagName');
            const editTagColorInput = document.getElementById('editTagColor');
            const editTagColorTextInput = document.getElementById('editTagColorText');
            
            if (!editTagIdInput || !editTagNameInput || !editTagColorInput || !editTagColorTextInput) {
                console.error('íƒœê·¸ í¸ì§‘ í¼ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                alert('íƒœê·¸ í¸ì§‘ í¼ì´ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            editTagIdInput.value = tagId;
            editTagNameInput.value = tagName;
            editTagColorInput.value = tagColor;
            editTagColorTextInput.value = tagColor;
            
            const modal = await createSafeModal('tagEditModal');
            if (modal) {
                modal.show();
            } else {
                console.error('íƒœê·¸ í¸ì§‘ ëª¨ë‹¬ ìƒì„± ì‹¤íŒ¨');
                alert('íƒœê·¸ í¸ì§‘ ëª¨ë‹¬ì„ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ë³´ì„¸ìš”.');
            }
        } catch (error) {
            console.error('íƒœê·¸ í¸ì§‘ ëª¨ë‹¬ ì—´ê¸° ì¤‘ ì˜¤ë¥˜:', error);
            alert('íƒœê·¸ í¸ì§‘ ëª¨ë‹¬ì„ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ë³´ì„¸ìš”.');
        }
    };

    // íƒœê·¸ ì‚­ì œ (ì „ì—­ í•¨ìˆ˜ë¡œ ì¶”ê°€)
    window.deleteTag = async function deleteTag(tagId, tagName) {
        if (!confirm(`"${tagName}" íƒœê·¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâ€» ì‚¬ìš© ì¤‘ì¸ íƒœê·¸ëŠ” ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
            return;
        }
        
        try {
            const response = await fetch(`/dashboard/api/tags/${tagId}/delete/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });
            
            const result = await response.json();
            
            if (result.success) {
                loadTagList();
                alert(result.message);
                refreshTagList();
            } else {
                alert(result.message);
            }
        } catch (error) {
            console.error('íƒœê·¸ ì‚­ì œ ì˜¤ë¥˜:', error);
            alert('íƒœê·¸ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    };

    // ê¸°íƒ€ í•¨ìˆ˜ë“¤
    const goToToday = () => {
        const url = new URL(window.location);
        url.searchParams.delete('date');
        window.location.href = url.toString();
    };
    
    // ìŠ¬ë¡¯ ì„ íƒ (ë‹¨ì¼ í´ë¦­)
    const selectSlot = (slotIndex) => {
        if (isDragging) return; // ë“œë˜ê·¸ ì¤‘ì´ë©´ ë¬´ì‹œ
        
        const slotElement = document.querySelector(`[data-slot-index="${slotIndex}"]`);
        if (!slotElement) return;
        
        // Ctrl/Cmd í‚¤ê°€ ëˆŒë ¸ëŠ”ì§€ í™•ì¸
        const isMultiSelect = event.ctrlKey || event.metaKey;
        
        if (!isMultiSelect) {
            // ë‹¨ì¼ ì„ íƒ: ëª¨ë“  ì„ íƒ í•´ì œ í›„ ìƒˆë¡œ ì„ íƒ
            clearSelection();
            selectedSlots.add(slotIndex);
            slotElement.classList.add('selected');
        } else {
            // ë‹¤ì¤‘ ì„ íƒ: í† ê¸€
            if (selectedSlots.has(slotIndex)) {
                selectedSlots.delete(slotIndex);
                slotElement.classList.remove('selected');
            } else {
                selectedSlots.add(slotIndex);
                slotElement.classList.add('selected');
            }
        }
        
        // ìŠ¬ë¡¯ ì •ë³´ í‘œì‹œ
        showSlotInfo(Array.from(selectedSlots));
        
        // ë²„íŠ¼ í™œì„±í™”
        updateButtons();
    };

    // ì„ íƒ í•´ì œ
    const clearSelection = () => {
        selectedSlots.clear();
        document.querySelectorAll('.time-slot').forEach(slot => {
            slot.classList.remove('selected');
        });
    };

    // ë“œë˜ê·¸ ì‹œì‘
    const startDrag = (slotIndex) => {
        isDragging = true;
        startSlot = slotIndex;
        
        // ê¸°ì¡´ ì„ íƒ í•´ì œ
        clearSelection();
        selectedSlots.add(slotIndex);
        
        const slotElement = document.querySelector(`[data-slot-index="${slotIndex}"]`);
        slotElement?.classList.add('selected');
        
        // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ ë°©ì§€
        event.preventDefault();
    };
    
    // ë“œë˜ê·¸ ì¤‘
    const dragOver = (slotIndex) => {
        if (!isDragging || startSlot === null) return;
        
        // ì‹œì‘ì ê³¼ í˜„ì¬ì  ì‚¬ì´ì˜ ëª¨ë“  ìŠ¬ë¡¯ ì„ íƒ
        const start = Math.min(startSlot, slotIndex);
        const end = Math.max(startSlot, slotIndex);
        
        // ê¸°ì¡´ ì„ íƒ í•´ì œ
        clearSelection();
        
        // ë²”ìœ„ ë‚´ ëª¨ë“  ìŠ¬ë¡¯ ì„ íƒ
        for (let i = start; i <= end; i++) {
            selectedSlots.add(i);
            const slotElement = document.querySelector(`[data-slot-index="${i}"]`);
            slotElement?.classList.add('selected');
        }
        
        showSlotInfo(Array.from(selectedSlots));
        updateButtons();
    };
    
    // ë“œë˜ê·¸ ì¢…ë£Œ
    const endDrag = () => {
        if (isDragging) {
            isDragging = false;
            startSlot = null;
            
            // ìµœì¢… ì„ íƒ ìƒíƒœ ì—…ë°ì´íŠ¸
            showSlotInfo(Array.from(selectedSlots));
            updateButtons();
        }
    };

    // í„°ì¹˜ ì´ë²¤íŠ¸ ì²˜ë¦¬
    const handleTouchMove = (event) => {
        if (!isDragging) return;
        
        event.preventDefault();
        const touch = event.touches[0];
        const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
        
        if (elementBelow && elementBelow.classList.contains('time-slot')) {
            const slotIndex = parseInt(elementBelow.dataset.slotIndex);
            if (!isNaN(slotIndex)) {
                dragOver(slotIndex);
            }
        }
    };
    
    // ì „ì—­ ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    document.addEventListener('mouseup', endDrag);
    document.addEventListener('mouseleave', endDrag);

    // ìŠ¬ë¡¯ ì •ë³´ í‘œì‹œ (ë‹¤ì¤‘ ì„ íƒ ì§€ì›)
    const showSlotInfo = (slotIndexes) => {
        if (!slotIndexes || slotIndexes.length === 0) {
            const slotInfoCard = document.getElementById('slotInfoCard');
            if (slotInfoCard) slotInfoCard.style.display = 'none';
            return;
        }
        
        let infoHTML = '';
        
        if (slotIndexes.length === 1) {
            // ë‹¨ì¼ ìŠ¬ë¡¯ ì •ë³´
            const slotIndex = slotIndexes[0];
            const slotElement = document.querySelector(`[data-slot-index="${slotIndex}"]`);
            if (!slotElement) return;
            
            const totalMinutes = slotIndex * 10;
            const hour = Math.floor(totalMinutes / 60);
            const minute = totalMinutes % 60;
            const endTotalMinutes = (slotIndex + 1) * 10;
            const endHour = Math.floor(endTotalMinutes / 60);
            const endMinute = endTotalMinutes % 60;
            
            const timeRange = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')} - ${endHour.toString().padStart(2, '0')}:${endMinute.toString().padStart(2, '0')}`;
            
            infoHTML = `
                <div class="mb-2">
                    <strong>ì‹œê°„:</strong> ${timeRange}
                </div>
                <div class="mb-2">
                    <strong>í˜„ì¬:</strong> 
                    ${slotElement.classList.contains('filled') ? slotElement.title : '<span class="text-muted">ë¹ˆ ìŠ¬ë¡¯</span>'}
                </div>
            `;
        } else {
            // ë‹¤ì¤‘ ìŠ¬ë¡¯ ì •ë³´
            const sortedSlots = slotIndexes.sort((a, b) => a - b);
            const startSlot = sortedSlots[0];
            const endSlot = sortedSlots[sortedSlots.length - 1];
            
            const startTotalMinutes = startSlot * 10;
            const startHour = Math.floor(startTotalMinutes / 60);
            const startMinute = startTotalMinutes % 60;
            
            const endTotalMinutes = (endSlot + 1) * 10;
            const endHour = Math.floor(endTotalMinutes / 60);
            const endMinute = endTotalMinutes % 60;
            
            const timeRange = `${startHour.toString().padStart(2, '0')}:${startMinute.toString().padStart(2, '0')} - ${endHour.toString().padStart(2, '0')}:${endMinute.toString().padStart(2, '0')}`;
            const totalDuration = slotIndexes.length * 10;
            const durationHours = Math.floor(totalDuration / 60);
            const durationMinutes = totalDuration % 60;
            
            infoHTML = `
                <div class="mb-2">
                    <strong>ì„ íƒëœ ìŠ¬ë¡¯:</strong> ${slotIndexes.length}ê°œ
                </div>
                <div class="mb-2">
                    <strong>ì‹œê°„ ë²”ìœ„:</strong> ${timeRange}
                </div>
                <div class="mb-2">
                    <strong>ì´ ì‹œê°„:</strong> ${durationHours}ì‹œê°„ ${durationMinutes}ë¶„
                </div>
            `;
        }
        
        const slotInfoElement = document.getElementById('slotInfo');
        const slotInfoCard = document.getElementById('slotInfoCard');
        
        if (slotInfoElement && slotInfoCard) {
            slotInfoElement.innerHTML = infoHTML;
            slotInfoCard.style.display = 'block';
        }
    };

    // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
    const updateButtons = () => {
        const saveBtn = document.getElementById('saveBtn');
        const deleteBtn = document.getElementById('deleteBtn');
        
        if (saveBtn) {
            saveBtn.disabled = !(selectedSlots.size > 0 && selectedTag !== null);
        }
        
        if (deleteBtn) {
            // ì„ íƒëœ ìŠ¬ë¡¯ ì¤‘ í•˜ë‚˜ë¼ë„ ì±„ì›Œì ¸ ìˆìœ¼ë©´ ì‚­ì œ ë²„íŠ¼ í™œì„±í™”
            const hasFilledSlot = Array.from(selectedSlots).some(slotIndex => {
                const slotElement = document.querySelector(`[data-slot-index="${slotIndex}"]`);
                return slotElement?.classList.contains('filled');
            });
            deleteBtn.disabled = !(selectedSlots.size > 0 && hasFilledSlot);
        }
    };
        
    const selectTag = (tagId, tagColor, tagName) => {
        // ì´ì „ ì„ íƒ í•´ì œ
        document.querySelectorAll('.tag-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // ìƒˆ ì„ íƒ ì ìš©
        event.target.classList.add('active');
        
        selectedTag = {
            id: tagId,
            color: tagColor,
            name: tagName
        };
        
        updateButtons();
    };

    // ìŠ¬ë¡¯ ì €ì¥ (ì‹¤ì œ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥)
    const saveSlot = async () => {
        if (selectedSlots.size === 0 || selectedTag === null) {
            alert('ìŠ¬ë¡¯ê³¼ íƒœê·¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }
        
        const memoInput = document.getElementById('memoInput');
        const memo = memoInput?.value || '';
        const selectedDate = document.getElementById('dateSelector')?.value || new Date().toISOString().split('T')[0];
        
        try {
            const response = await fetch('/dashboard/api/save-blocks/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    slot_indexes: Array.from(selectedSlots),
                    tag_id: selectedTag.id,
                    memo: memo,
                    date: selectedDate
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                // ì„±ê³µì‹œ UI ì—…ë°ì´íŠ¸
                selectedSlots.forEach(slotIndex => {
                    const slotElement = document.querySelector(`[data-slot-index="${slotIndex}"]`);
                    if (!slotElement) return;
                    
                    slotElement.style.backgroundColor = selectedTag.color;
                    slotElement.classList.add('filled');
                    slotElement.title = `${slotElement.dataset.time} - ${selectedTag.name}${memo ? ': ' + memo : ''}`;
                    
                    // ë‚´ë¶€ HTML ì—…ë°ì´íŠ¸
                    slotElement.innerHTML = `
                        <div class="position-absolute w-100 h-100 d-flex align-items-center justify-content-center">
                            <small class="text-white fw-bold" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">
                                ${selectedTag.name.substring(0, 3)}
                            </small>
                        </div>
                    `;
                });
                
                // ìƒíƒœ ì´ˆê¸°í™”
                if (memoInput) memoInput.value = '';
                clearSelection();
                selectedTag = null;
                
                // íƒœê·¸ ë²„íŠ¼ ì„ íƒ í•´ì œ
                document.querySelectorAll('.tag-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                updateButtons();
                const slotInfoCard = document.getElementById('slotInfoCard');
                if (slotInfoCard) slotInfoCard.style.display = 'none';
                
                // ì„±ê³µ ë©”ì‹œì§€ë¥¼ ì½˜ì†”ì— í‘œì‹œ (ëª¨ë‹¬ì´ ì‚¬ë¼ì§€ì§€ ì•Šë„ë¡)
                console.log('ìŠ¬ë¡¯ ì €ì¥ ì„±ê³µ:', result.message);
                
                // ì‹œê°ì  í”¼ë“œë°± ì œê³µ
                const notification = document.createElement('div');
                notification.className = 'alert alert-success position-fixed';
                notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; animation: fadeInOut 3s forwards;';
                notification.innerHTML = `<i class="fas fa-check-circle me-2"></i>${result.message}`;
                document.body.appendChild(notification);
                
                // 3ì´ˆ í›„ ì•Œë¦¼ ì œê±°
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 3000);
            } else {
                alert('ì €ì¥ ì‹¤íŒ¨: ' + result.message);
            }
        } catch (error) {
            console.error('ì €ì¥ ì¤‘ ì˜¤ë¥˜:', error);
            alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    };
    
    // ìŠ¬ë¡¯ ì‚­ì œ (ì‹¤ì œ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì‚­ì œ)
    const deleteSlot = async () => {
        if (selectedSlots.size === 0) {
            alert('ì‚­ì œí•  ìŠ¬ë¡¯ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }
        
        const filledSlots = Array.from(selectedSlots).filter(slotIndex => {
            const slotElement = document.querySelector(`[data-slot-index="${slotIndex}"]`);
            return slotElement?.classList.contains('filled');
        });
        
        if (filledSlots.length === 0) {
            alert('ì‚­ì œí•  ìˆ˜ ìˆëŠ” ê¸°ë¡ëœ ìŠ¬ë¡¯ì´ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        
        if (confirm(`${filledSlots.length}ê°œì˜ ê¸°ë¡ëœ ìŠ¬ë¡¯ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            const selectedDate = document.getElementById('dateSelector')?.value || new Date().toISOString().split('T')[0];
            
            try {
                const response = await fetch('/dashboard/api/delete-blocks/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        slot_indexes: filledSlots,
                        date: selectedDate
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // ì„±ê³µì‹œ UI ì—…ë°ì´íŠ¸
                    filledSlots.forEach(slotIndex => {
                        const slotElement = document.querySelector(`[data-slot-index="${slotIndex}"]`);
                        if (!slotElement) return;
                        
                        slotElement.style.backgroundColor = '';
                        slotElement.classList.remove('filled');
                        slotElement.title = `${slotElement.dataset.time} - ë¹ˆ ìŠ¬ë¡¯`;
                        slotElement.innerHTML = '';
                    });
                    
                    clearSelection();
                    updateButtons();
                    
                    const slotInfoCard = document.getElementById('slotInfoCard');
                    if (slotInfoCard) slotInfoCard.style.display = 'none';
                    
                    alert(result.message);
                    
                    // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ í†µê³„ ì—…ë°ì´íŠ¸
                    window.location.reload();
                } else {
                    alert('ì‚­ì œ ì‹¤íŒ¨: ' + result.message);
                }
            } catch (error) {
                console.error('ì‚­ì œ ì¤‘ ì˜¤ë¥˜:', error);
                alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
    };
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // íƒœê·¸ ë¡œë”© ë° ë Œë”ë§ ê¸°ëŠ¥
    async function loadAvailableTags() {
        try {
            const response = await fetch('/dashboard/api/tags/');
            const result = await response.json();
            
            if (result.success) {
                availableTags = result.tags;
                renderTagContainer(result.tags);
                renderTagLegend(result.tags);
            } else {
                showTagError('íƒœê·¸ ë¡œë“œ ì‹¤íŒ¨: ' + result.message);
            }
        } catch (error) {
            console.error('íƒœê·¸ ë¡œë“œ ì˜¤ë¥˜:', error);
            showTagError('íƒœê·¸ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }
    
    function renderTagContainer(tags) {
        const tagContainer = document.getElementById('tagContainer');
        
        if (tags.length === 0) {
            tagContainer.innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-tags text-muted mb-3" style="font-size: 2rem;"></i>
                    <p class="text-muted mb-3">íƒœê·¸ë¥¼ ë¨¼ì € ìƒì„±í•´ì£¼ì„¸ìš”.</p>
                    <button class="btn btn-primary btn-sm" id="createFirstTagBtn">
                        <i class="fas fa-plus me-1"></i>
                        ì²« ë²ˆì§¸ íƒœê·¸ ë§Œë“¤ê¸°
                    </button>
                </div>
            `;
            
            document.getElementById('createFirstTagBtn').addEventListener('click', function() {
                if (window.openCreateTagModal) {
                    window.openCreateTagModal();
                }
            });
            return;
        }
        
        let html = '';
        tags.forEach(tag => {
            html += `
                <button class="btn btn-outline-secondary btn-sm tag-btn" 
                        data-tag-id="${tag.id}"
                        data-tag-color="${tag.color}"
                        data-is-default="${tag.is_default}"
                        onclick="selectTag(${tag.id}, '${tag.color}', '${tag.name}')">
                    <span class="badge me-2" style="background-color: ${tag.color};">&nbsp;</span>
                    ${tag.name}
                    ${tag.is_default ? '<small class="text-muted ms-1">(ê¸°ë³¸)</small>' : ''}
                </button>
            `;
        });
        
        tagContainer.innerHTML = html;
    }
    
    function renderTagLegend(tags) {
        const tagLegend = document.getElementById('tagLegend');
        
        if (tags.length === 0) {
            tagLegend.innerHTML = `
                <small class="text-muted">
                    <i class="fas fa-info-circle me-1"></i>
                    íƒœê·¸ë¥¼ ë¨¼ì € ìƒì„±í•´ì£¼ì„¸ìš”.
                </small>
            `;
            return;
        }
        
        let html = '';
        tags.forEach(tag => {
            html += `
                <span class="badge" style="background-color: ${tag.color};">
                    ${tag.name}
                </span>
            `;
        });
        
        tagLegend.innerHTML = html;
    }
    
    function showTagError(message) {
        const tagContainer = document.getElementById('tagContainer');
        const tagLegend = document.getElementById('tagLegend');
        
        const errorHtml = `
            <div class="alert alert-danger alert-sm">
                <i class="fas fa-exclamation-triangle me-1"></i>
                ${message}
                <button class="btn btn-sm btn-outline-danger ms-2" onclick="loadAvailableTags()">
                    <i class="fas fa-redo"></i> ë‹¤ì‹œ ì‹œë„
                </button>
            </div>
        `;
        
        tagContainer.innerHTML = errorHtml;
        tagLegend.innerHTML = '<small class="text-danger">íƒœê·¸ ë¡œë“œ ì‹¤íŒ¨</small>';
    }
    
    function refreshTagList() {
        loadAvailableTags();
    }
</script>
{% endblock %} 