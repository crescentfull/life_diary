{% extends 'base.html' %}
{% load static %}

{% block title %}대시보드 - {{ selected_date|date:"Y년 m월 d일" }} | 라이프 다이어리{% endblock %}

{% block content %}
<div class="row">
    <!-- 날짜 선택 및 통계 -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-calendar-day me-2"></i>
                    {{ selected_date|date:"Y년 m월 d일 (l)" }}
                </h5>
                <div class="d-flex gap-2">
                    <input type="date" 
                           class="form-control form-control-sm" 
                           id="dateSelector" 
                           value="{{ selected_date|date:'Y-m-d' }}"
                           style="width: 150px;">
                    <button class="btn btn-sm btn-outline-primary" onclick="goToToday()">
                        <i class="fas fa-home"></i> 오늘
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <div class="d-flex align-items-center justify-content-center">
                            <i class="fas fa-clock text-primary me-2"></i>
                            <div>
                                <div class="fw-bold">{{ total_slots }}</div>
                                <small class="text-muted">총 슬롯</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-flex align-items-center justify-content-center">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            <div>
                                <div class="fw-bold">{{ filled_slots }}</div>
                                <small class="text-muted">기록된 슬롯</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-flex align-items-center justify-content-center">
                            <i class="fas fa-chart-pie text-info me-2"></i>
                            <div>
                                <div class="fw-bold">{{ fill_percentage }}%</div>
                                <small class="text-muted">기록률</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-flex align-items-center justify-content-center">
                            <i class="fas fa-hourglass-half text-warning me-2"></i>
                            <div>
                                <div class="fw-bold">{{ total_hours }}시간 {{ remaining_minutes }}분</div>
                                <small class="text-muted">총 기록 시간</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- 시간 그리드 -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-th me-2"></i>
                    시간 그리드 (10분 단위)
                </h6>
            </div>
            <div class="card-body">
                <!-- 시간 표시 헤더 (그리드와 동일한 12열 구조) -->
                <div class="time-grid mb-3" style="grid-template-columns: repeat(12, 1fr); display: grid; gap: 2px;">
                    {% for time_header in time_headers %}
                        <div class="text-center text-muted small py-1" style="font-weight: 500;">
                            {{ time_header }}
                        </div>
                    {% endfor %}
                </div>
                
                <!-- 144칸 그리드 -->
                <div class="time-grid" id="timeGrid">
                    {% for slot in slots %}
                        <div class="time-slot {% if slot.data %}filled{% endif %}" 
                             data-slot-index="{{ slot.index }}"
                             data-time="{{ slot.time_str }}"
                             {% if slot.data %}
                                 style="background-color: {{ slot.data.tag.color }};"
                                 title="{{ slot.time_str }} - {{ slot.data.tag.name }}{% if slot.data.memo %}: {{ slot.data.memo }}{% endif %}"
                             {% else %}
                                 title="{{ slot.time_str }} - 빈 슬롯"
                             {% endif %}
                             onclick="selectSlot({{ slot.index }})"
                             onmousedown="startDrag({{ slot.index }})"
                             onmouseenter="dragOver({{ slot.index }})"
                             onmouseup="endDrag()"
                             ontouchstart="startDrag({{ slot.index }})"
                             ontouchmove="handleTouchMove(event)"
                             ontouchend="endDrag()">
                            
                            <!-- 시간 표시 (매 시간마다) -->
                            {% if slot.minute == 0 %}
                                <div class="slot-time">{{ slot.hour|stringformat:"02d" }}:00</div>
                            {% endif %}
                            
                            <!-- 태그 표시 -->
                            {% if slot.data %}
                                <div class="position-absolute w-100 h-100 d-flex align-items-center justify-content-center">
                                    <small class="text-white fw-bold" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">
                                        {{ slot.data.tag.name|truncatechars:3 }}
                                    </small>
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
                
                <!-- 범례 -->
                <div class="mt-3">
                    <div class="d-flex flex-wrap gap-2" id="tagLegend">
                        <div class="spinner-border spinner-border-sm text-secondary" role="status">
                            <span class="visually-hidden">범례 로딩 중...</span>
                        </div>
                        <small class="text-muted">범례 로딩 중...</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 사이드바 - 태그 선택 및 정보 -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-edit me-2"></i>
                    빠른 입력
                </h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label class="form-label mb-0">태그 선택</label>
                        <div>
                            <button type="button" class="btn btn-sm btn-outline-success me-1" id="createNewTagBtn">
                                <i class="fas fa-plus"></i> 새 태그
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-primary me-1" id="manageTagsBtn">
                                <i class="fas fa-cog"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="collapse" data-bs-target="#usageHelp" aria-expanded="false" aria-controls="usageHelp">
                                <i class="fas fa-question-circle"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="collapse" id="usageHelp" data-bs-parent="">
                        <div class="card border-info mt-2">
                            <div class="card-body bg-light py-2">
                                <small class="text-info">
                                    <i class="fas fa-info-circle me-1"></i><strong>사용법:</strong><br>
                                    • <strong>단일 선택:</strong> 슬롯 클릭<br>
                                    • <strong>드래그 선택:</strong> 마우스로 드래그<br>
                                    • <strong>다중 선택:</strong> Ctrl/Cmd + 클릭<br>
                                    • <strong>터치:</strong> 터치 후 드래그<br><br>
                                    <small class="text-muted">💡 이 도움말은 ? 버튼을 다시 클릭하면 닫힙니다.</small>
                                </small>
                            </div>
                        </div>
                        </div>
                    </div>
                    
                    <!-- 태그 목록이 동적으로 로드됩니다 -->
                    <div class="d-grid gap-2" id="tagContainer">
                        <div class="text-center py-3">
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                <span class="visually-hidden">태그 로딩 중...</span>
                            </div>
                            <div class="mt-2 text-muted small">태그 로딩 중...</div>
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="memoInput" class="form-label">메모 (선택사항)</label>
                    <textarea class="form-control" id="memoInput" rows="3" placeholder="메모를 입력하세요..."></textarea>
                </div>
                
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" onclick="saveSlot()" disabled id="saveBtn">
                        <i class="fas fa-save me-1"></i>
                        저장
                    </button>
                    <button class="btn btn-outline-danger" onclick="deleteSlot()" disabled id="deleteBtn">
                        <i class="fas fa-trash me-1"></i>
                        삭제
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 선택된 슬롯 정보 -->
        <div class="card mt-3" id="slotInfoCard" style="display: none;">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    선택된 슬롯
                </h6>
            </div>
            <div class="card-body">
                <div id="slotInfo">
                    <!-- JavaScript로 동적 업데이트 -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 모달들 -->
<!-- 새 태그 추가 모달 -->
<div class="modal fade" id="createTagModal" tabindex="-1" aria-labelledby="createTagModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createTagModalLabel">
                    <i class="fas fa-plus me-2"></i>새 태그 만들기
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createTagForm">
                    <div class="mb-3">
                        <label for="newTagName" class="form-label">태그명</label>
                        <input type="text" class="form-control" id="newTagName" placeholder="예: 운동, 공부, 휴식">
                    </div>
                    <div class="mb-3">
                        <label for="newTagColor" class="form-label">색상</label>
                        <div class="d-flex align-items-center gap-2">
                            <input type="color" class="form-control form-control-color" id="newTagColor" value="#3498db">
                            <input type="text" class="form-control" id="newTagColorText" placeholder="#3498db" maxlength="7">
                        </div>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus me-1"></i>태그 생성
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 태그 관리 모달 -->
<div class="modal fade" id="tagManageModal" tabindex="-1" aria-labelledby="tagManageModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="tagManageModalLabel">
                    <i class="fas fa-tags me-2"></i>태그 관리
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- 기존 태그 목록 -->
                <div id="tagList">
                    <!-- JavaScript로 동적 로드 -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>

<!-- 태그 편집 모달 -->
<div class="modal fade" id="tagEditModal" tabindex="-1" aria-labelledby="tagEditModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="tagEditModalLabel">
                    <i class="fas fa-edit me-2"></i>태그 편집
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editTagForm">
                    <input type="hidden" id="editTagId">
                    <div class="mb-3">
                        <label for="editTagName" class="form-label">태그명</label>
                        <input type="text" class="form-control" id="editTagName">
                    </div>
                    <div class="mb-3">
                        <label for="editTagColor" class="form-label">색상</label>
                        <div class="d-flex align-items-center gap-2">
                            <input type="color" class="form-control form-control-color" id="editTagColor">
                            <input type="text" class="form-control" id="editTagColorText" maxlength="7">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" id="saveTagBtn">
                    <i class="fas fa-save me-1"></i>저장
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<link rel="stylesheet" type="text/css" href="{% static 'dashboard/css/dashboard.css' %}">
{% endblock %}

{% block extra_js %}
<script src="{% static 'dashboard/js/dashboard.js' %}"></script>
{% endblock %} 