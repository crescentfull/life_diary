{% extends 'base.html' %}

{% block title %}ëŒ€ì‹œë³´ë“œ - {{ selected_date|date:"Yë…„ mì›” dì¼" }} | ë¼ì´í”„ ë‹¤ì´ì–´ë¦¬{% endblock %}

{% block extra_css %}
<style>
/* íƒœê·¸ ê´€ë¦¬ ëª¨ë‹¬ ìœ„ì—ì„œ ë‹¤ë¥¸ ëª¨ë‹¬ì´ ì—´ë¦´ ë•Œ z-indexë¥¼ ë†’ì—¬ ë§¨ ì•ìœ¼ë¡œ ì˜¤ê²Œ í•¨ */
#createTagModal, #tagEditModal {
    z-index: 1060;
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <!-- ë‚ ì§œ ì„ íƒ ë° í†µê³„ -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-calendar-day me-2"></i>
                    {{ selected_date|date:"Yë…„ mì›” dì¼ (l)" }}
                </h5>
                <div class="d-flex gap-2">
                    <input type="date" 
                           class="form-control form-control-sm" 
                           id="dateSelector" 
                           value="{{ selected_date|date:'Y-m-d' }}"
                           style="width: 150px;">
                    <button class="btn btn-sm btn-outline-primary" onclick="goToToday()">
                        <i class="fas fa-home"></i> ì˜¤ëŠ˜
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <div class="d-flex align-items-center justify-content-center">
                            <i class="fas fa-clock text-primary me-2"></i>
                            <div>
                                <div class="fw-bold">{{ total_slots }}</div>
                                <small class="text-muted">ì´ ìŠ¬ë¡¯</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-flex align-items-center justify-content-center">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            <div>
                                <div class="fw-bold">{{ filled_slots }}</div>
                                <small class="text-muted">ê¸°ë¡ëœ ìŠ¬ë¡¯</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-flex align-items-center justify-content-center">
                            <i class="fas fa-chart-pie text-info me-2"></i>
                            <div>
                                <div class="fw-bold">{{ fill_percentage }}%</div>
                                <small class="text-muted">ê¸°ë¡ë¥ </small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-flex align-items-center justify-content-center">
                            <i class="fas fa-hourglass-half text-warning me-2"></i>
                            <div>
                                <div class="fw-bold">{{ total_hours }}ì‹œê°„ {{ remaining_minutes }}ë¶„</div>
                                <small class="text-muted">ì´ ê¸°ë¡ ì‹œê°„</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- ì‹œê°„ ê·¸ë¦¬ë“œ -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-th me-2"></i>
                    ì‹œê°„ ê·¸ë¦¬ë“œ (10ë¶„ ë‹¨ìœ„)
                </h6>
            </div>
            <div class="card-body">
                <!-- ì‹œê°„ í‘œì‹œ í—¤ë” (ê·¸ë¦¬ë“œì™€ ë™ì¼í•œ 12ì—´ êµ¬ì¡°) -->
                <div class="time-grid mb-3" style="grid-template-columns: repeat(12, 1fr); display: grid; gap: 2px;">
                    {% for time_header in time_headers %}
                        <div class="text-center text-muted small py-1" style="font-weight: 500;">
                            {{ time_header }}
                        </div>
                    {% endfor %}
                </div>
                
                <!-- 144ì¹¸ ê·¸ë¦¬ë“œ -->
                <div class="time-grid" id="timeGrid">
                    {% for slot in slots %}
                        <div class="time-slot {% if slot.data %}filled{% endif %}" 
                             data-slot-index="{{ slot.index }}"
                             data-time="{{ slot.time_str }}"
                             {% if slot.data %}
                                 style="background-color: {{ slot.data.tag.color }};"
                                 title="{{ slot.time_str }} - {{ slot.data.tag.name }}{% if slot.data.memo %}: {{ slot.data.memo }}{% endif %}"
                             {% else %}
                                 title="{{ slot.time_str }} - ë¹ˆ ìŠ¬ë¡¯"
                             {% endif %}
                             onclick="selectSlot({{ slot.index }})"
                             onmousedown="startDrag({{ slot.index }})"
                             onmouseenter="dragOver({{ slot.index }})"
                             onmouseup="endDrag()"
                             ontouchstart="startDrag({{ slot.index }})"
                             ontouchmove="handleTouchMove(event)"
                             ontouchend="endDrag()">
                            
                            <!-- ì‹œê°„ í‘œì‹œ (ë§¤ ì‹œê°„ë§ˆë‹¤) -->
                            {% if slot.minute == 0 %}
                                <div class="slot-time">{{ slot.hour|stringformat:"02d" }}:00</div>
                            {% endif %}
                            
                            <!-- íƒœê·¸ í‘œì‹œ -->
                            {% if slot.data %}
                                <div class="position-absolute w-100 h-100 d-flex align-items-center justify-content-center">
                                    <small class="text-white fw-bold" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">
                                        {{ slot.data.tag.name|truncatechars:3 }}
                                    </small>
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
                
                <!-- ë²”ë¡€ -->
                <div class="mt-3">
                    <div class="d-flex flex-wrap gap-2" id="tagLegend">
                        <div class="spinner-border spinner-border-sm text-secondary" role="status">
                            <span class="visually-hidden">ë²”ë¡€ ë¡œë”© ì¤‘...</span>
                        </div>
                        <small class="text-muted">ë²”ë¡€ ë¡œë”© ì¤‘...</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ì‚¬ì´ë“œë°” - íƒœê·¸ ì„ íƒ ë° ì •ë³´ -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-edit me-2"></i>
                    ë¹ ë¥¸ ì…ë ¥
                </h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label class="form-label mb-0">íƒœê·¸ ì„ íƒ</label>
                        <div>
                            <button type="button" class="btn btn-sm btn-outline-success me-1" id="createNewTagBtn">
                                <i class="fas fa-plus"></i> ìƒˆ íƒœê·¸
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-primary me-1" id="manageTagsBtn">
                                <i class="fas fa-cog"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="collapse" data-bs-target="#usageHelp" aria-expanded="false" aria-controls="usageHelp">
                                <i class="fas fa-question-circle"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="collapse" id="usageHelp" data-bs-parent="">
                        <div class="card border-info mt-2">
                            <div class="card-body bg-light py-2">
                                <small class="text-info">
                                    <i class="fas fa-info-circle me-1"></i><strong>ì‚¬ìš©ë²•:</strong><br>
                                    â€¢ <strong>ë‹¨ì¼ ì„ íƒ:</strong> ìŠ¬ë¡¯ í´ë¦­<br>
                                    â€¢ <strong>ë“œë˜ê·¸ ì„ íƒ:</strong> ë§ˆìš°ìŠ¤ë¡œ ë“œë˜ê·¸<br>
                                    â€¢ <strong>ë‹¤ì¤‘ ì„ íƒ:</strong> Ctrl/Cmd + í´ë¦­<br>
                                    â€¢ <strong>í„°ì¹˜:</strong> í„°ì¹˜ í›„ ë“œë˜ê·¸<br><br>
                                    <small class="text-muted">ğŸ’¡ ì´ ë„ì›€ë§ì€ ? ë²„íŠ¼ì„ ë‹¤ì‹œ í´ë¦­í•˜ë©´ ë‹«í™ë‹ˆë‹¤.</small>
                                </small>
                            </div>
                        </div>
                        </div>
                    </div>
                    
                    <!-- íƒœê·¸ ëª©ë¡ì´ ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
                    <div class="d-grid gap-2" id="tagContainer">
                        <div class="text-center py-3">
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                <span class="visually-hidden">íƒœê·¸ ë¡œë”© ì¤‘...</span>
                            </div>
                            <div class="mt-2 text-muted small">íƒœê·¸ ë¡œë”© ì¤‘...</div>
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="memoInput" class="form-label">ë©”ëª¨ (ì„ íƒì‚¬í•­)</label>
                    <textarea class="form-control" id="memoInput" rows="3" placeholder="ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                </div>
                
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" onclick="saveSlot()" disabled id="saveBtn">
                        <i class="fas fa-save me-1"></i>
                        ì €ì¥
                    </button>
                    <button class="btn btn-outline-danger" onclick="deleteSlot()" disabled id="deleteBtn">
                        <i class="fas fa-trash me-1"></i>
                        ì‚­ì œ
                    </button>
                </div>
            </div>
        </div>
        
        <!-- ì„ íƒëœ ìŠ¬ë¡¯ ì •ë³´ -->
        <div class="card mt-3" id="slotInfoCard" style="display: none;">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    ì„ íƒëœ ìŠ¬ë¡¯
                </h6>
            </div>
            <div class="card-body">
                <div id="slotInfo">
                    <!-- JavaScriptë¡œ ë™ì  ì—…ë°ì´íŠ¸ -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- íƒœê·¸ ê´€ë¦¬ ëª¨ë‹¬, í¸ì§‘ ëª¨ë‹¬, ìƒì„± ëª¨ë‹¬ ë“±ì€ ì´ì œ ê³µí†µ í…œí”Œë¦¿ìœ¼ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤ -->
{% include 'tags/_tag_modal.html' %}

{% endblock %}

{% block extra_js %}
{% load static %}
<script src="{% static 'core/js/tag.js' %}" defer></script>
<script>
    let selectedSlots = new Set(); // ì„ íƒëœ ìŠ¬ë¡¯ë“¤ì„ ì €ì¥í•˜ëŠ” Set
    let selectedTag = null;
    let isDragging = false;
    let startSlot = null;
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ íƒœê·¸ ëª©ë¡ ë¡œë“œ ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    document.addEventListener('DOMContentLoaded', function() {
        // ëŒ€ì‹œë³´ë“œ ê´€ë ¨ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        initializeDashboard();
        
        // íƒœê·¸ ì—…ë°ì´íŠ¸ ì´ë²¤íŠ¸ ìˆ˜ì‹ 
        document.addEventListener('tags-updated', function() {
            console.log("Dashboard: 'tags-updated' ì´ë²¤íŠ¸ ìˆ˜ì‹ . íƒœê·¸ ëª©ë¡ì„ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.");
            loadAvailableTags();
        });
    });

    function initializeDashboard() {
        loadAvailableTags();
        
        const dateSelector = document.getElementById('dateSelector');
        if (dateSelector) {
            dateSelector.addEventListener('change', (event) => {
                const selectedDate = event.target.value;
                const url = new URL(window.location);
                url.searchParams.set('date', selectedDate);
                window.location.href = url.toString();
            });
        }

        // 'ìƒˆ íƒœê·¸' ë²„íŠ¼ í´ë¦­ ì‹œ ê³µí†µ ëª¨ë‹¬ ì—´ê¸°
        document.getElementById('createNewTagBtn').addEventListener('click', function() {
            window.openTagFormModal(); // ì¸ì ì—†ì´ í˜¸ì¶œí•˜ì—¬ 'ìƒì„±' ëª¨ë“œë¡œ
        });

        // 'íƒœê·¸ ê´€ë¦¬' ë²„íŠ¼ (ì´ ë²„íŠ¼ì€ ë³„ë„ í˜ì´ì§€ë¡œ ë§í¬ ë˜ëŠ” ë‹¤ë¥¸ ëª¨ë‹¬ í•„ìš” - í˜„ì¬ëŠ” ìƒì„± ëª¨ë‹¬ë§Œ ì—°ê²°)
        document.getElementById('manageTagsBtn').addEventListener('click', function() {
            // ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ ìƒˆ íƒœê·¸ ëª¨ë‹¬ì„ ì—´ê±°ë‚˜, ì „ìš© ê´€ë¦¬ í˜ì´ì§€ë¡œ ì´ë™ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            // ì§€ê¸ˆì€ tags ì•±ì˜ index í˜ì´ì§€ë¡œ ì´ë™í•˜ë„ë¡ ì²˜ë¦¬í•©ë‹ˆë‹¤.
            window.location.href = "{% url 'tags:index' %}";
        });
    }

    // ìŠ¬ë¡¯ ì„ íƒ (ë‹¨ì¼ í´ë¦­)
    const selectSlot = (slotIndex) => {
        if (isDragging) return; // ë“œë˜ê·¸ ì¤‘ì´ë©´ ë¬´ì‹œ
        
        const slotElement = document.querySelector(`[data-slot-index="${slotIndex}"]`);
        if (!slotElement) return;
        
        const isMultiSelect = event.ctrlKey || event.metaKey;
        
        if (!isMultiSelect) {
            clearSelection();
            selectedSlots.add(slotIndex);
            slotElement.classList.add('selected');
        } else {
            if (selectedSlots.has(slotIndex)) {
                selectedSlots.delete(slotIndex);
                slotElement.classList.remove('selected');
            } else {
                selectedSlots.add(slotIndex);
                slotElement.classList.add('selected');
            }
        }
        
        showSlotInfo(Array.from(selectedSlots));
        updateButtons();
    };

    // ì„ íƒ í•´ì œ
    const clearSelection = () => {
        selectedSlots.clear();
        document.querySelectorAll('.time-slot').forEach(slot => {
            slot.classList.remove('selected');
        });
    };

    // ë“œë˜ê·¸ ì‹œì‘/ì¢…ë£Œ ë° í„°ì¹˜ ê´€ë ¨ í•¨ìˆ˜ë“¤ (ê¸°ì¡´ ì½”ë“œì™€ ë™ì¼)
    const startDrag = (slotIndex) => {
        isDragging = true;
        startSlot = slotIndex;
        clearSelection();
        selectedSlots.add(slotIndex);
        const slotElement = document.querySelector(`[data-slot-index="${slotIndex}"]`);
        if(slotElement) slotElement.classList.add('selected');
        event.preventDefault();
    };
    
    const dragOver = (slotIndex) => {
        if (!isDragging || startSlot === null) return;
        const start = Math.min(startSlot, slotIndex);
        const end = Math.max(startSlot, slotIndex);
        clearSelection();
        for (let i = start; i <= end; i++) {
            selectedSlots.add(i);
            const slotElement = document.querySelector(`[data-slot-index="${i}"]`);
            if(slotElement) slotElement.classList.add('selected');
        }
        showSlotInfo(Array.from(selectedSlots));
        updateButtons();
    };
    
    const endDrag = () => {
        if (isDragging) {
            isDragging = false;
            startSlot = null;
            showSlotInfo(Array.from(selectedSlots));
            updateButtons();
        }
    };

    const handleTouchMove = (event) => {
        if (!isDragging) return;
        event.preventDefault();
        const touch = event.touches[0];
        const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
        if (elementBelow && elementBelow.classList.contains('time-slot')) {
            const slotIndex = parseInt(elementBelow.dataset.slotIndex, 10);
            if (!isNaN(slotIndex)) {
                dragOver(slotIndex);
            }
        }
    };
    
    document.addEventListener('mouseup', endDrag);
    document.addEventListener('mouseleave', endDrag);

    // ìŠ¬ë¡¯ ì •ë³´ í‘œì‹œ (ê¸°ì¡´ ì½”ë“œì™€ ë™ì¼)
    const showSlotInfo = (slotIndexes) => {
        const slotInfoCard = document.getElementById('slotInfoCard');
        const slotInfoElement = document.getElementById('slotInfo');
        if (!slotIndexes || slotIndexes.length === 0) {
            if(slotInfoCard) slotInfoCard.style.display = 'none';
            return;
        }
        
        let infoHTML = '';
        if (slotIndexes.length === 1) {
            const slotIndex = slotIndexes[0];
            const slotElement = document.querySelector(`[data-slot-index="${slotIndex}"]`);
            if (!slotElement) return;
            
            const timeRange = slotElement.getAttribute('title').split(' - ')[0];
            let tagName = 'ë¹ˆ ìŠ¬ë¡¯';
            if (slotElement.classList.contains('filled')) {
                const titleParts = slotElement.title.split(' - ');
                tagName = titleParts.length > 1 ? titleParts[1].split(':')[0] : 'ì•Œ ìˆ˜ ì—†ìŒ';
            }
            infoHTML = `<div class="mb-2"><strong>ì‹œê°„:</strong> ${timeRange}</div>
                        <div class="mb-2"><strong>ìƒíƒœ:</strong> ${tagName}</div>`;
        } else {
             const sortedSlots = slotIndexes.sort((a, b) => a - b);
            const startSlot = sortedSlots[0];
            const endSlot = sortedSlots[sortedSlots.length - 1];

            const startElem = document.querySelector(`[data-slot-index="${startSlot}"]`);
            const endElem = document.querySelector(`[data-slot-index="${endSlot}"]`);

            if(startElem && endElem){
                const startTime = startElem.dataset.time.split('-')[0];
                const endTime = endElem.dataset.time.split('-')[1];
                const duration = slotIndexes.length * 10;
                infoHTML = `<div class="mb-2"><strong>ì„ íƒ:</strong> ${slotIndexes.length}ê°œ ìŠ¬ë¡¯</div>
                            <div class="mb-2"><strong>ì‹œê°„:</strong> ${startTime} - ${endTime}</div>
                            <div class="mb-2"><strong>ì´:</strong> ${Math.floor(duration/60)}ì‹œê°„ ${duration%60}ë¶„</div>`;
            }
        }

        if(slotInfoElement) slotInfoElement.innerHTML = infoHTML;
        if(slotInfoCard) slotInfoCard.style.display = 'block';
    };

    // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ (ê¸°ì¡´ ì½”ë“œì™€ ë™ì¼)
    const updateButtons = () => {
        const saveBtn = document.getElementById('saveBtn');
        const deleteBtn = document.getElementById('deleteBtn');
        if (saveBtn) saveBtn.disabled = !(selectedSlots.size > 0 && selectedTag !== null);
        if (deleteBtn) {
            const hasFilledSlot = Array.from(selectedSlots).some(idx => 
                document.querySelector(`[data-slot-index="${idx}"]`)?.classList.contains('filled')
            );
            deleteBtn.disabled = !hasFilledSlot;
        }
    };
        
    // íƒœê·¸ ì„ íƒ (ê¸°ì¡´ ì½”ë“œì™€ ë™ì¼)
    const selectTag = (tagId, tagColor, tagName) => {
        document.querySelectorAll('.tag-btn').forEach(btn => btn.classList.remove('active'));
        const targetBtn = event.target.closest('.tag-btn');
        if(targetBtn) targetBtn.classList.add('active');
        selectedTag = { id: tagId, color: tagColor, name: tagName };
        updateButtons();
    };

    // ìŠ¬ë¡¯ ì €ì¥/ì‚­ì œ (ê¸°ì¡´ ì½”ë“œì™€ ë™ì¼, CSRF í† í° í•¨ìˆ˜ í•„ìš”)
    const saveSlot = async () => {
        if (selectedSlots.size === 0 || !selectedTag) return;
        const memo = document.getElementById('memoInput').value || '';
        const date = document.getElementById('dateSelector').value;

        const response = await fetch('/dashboard/api/save-blocks/', {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken')},
            body: JSON.stringify({ slot_indexes: Array.from(selectedSlots), tag_id: selectedTag.id, memo, date })
        });
        const result = await response.json();
        if (result.success) {
            // UI ì—…ë°ì´íŠ¸ ë° ìƒíƒœ ì´ˆê¸°í™”
            location.reload(); // ê°„ë‹¨í•˜ê²Œ ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ ì²˜ë¦¬
        } else {
            alert('ì €ì¥ ì‹¤íŒ¨: ' + result.message);
        }
    };
    
    const deleteSlot = async () => {
        if (!confirm('ì„ íƒëœ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        const filledSlots = Array.from(selectedSlots).filter(idx => 
            document.querySelector(`[data-slot-index="${idx}"]`)?.classList.contains('filled')
        );
        if (filledSlots.length === 0) return;
        
        const date = document.getElementById('dateSelector').value;
        const response = await fetch('/dashboard/api/delete-blocks/', {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken')},
            body: JSON.stringify({ slot_indexes: filledSlots, date })
        });
        const result = await response.json();
        if (result.success) {
            location.reload(); // ê°„ë‹¨í•˜ê²Œ ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ ì²˜ë¦¬
        } else {
            alert('ì‚­ì œ ì‹¤íŒ¨: ' + result.message);
        }
    };
    
    // íƒœê·¸ ë¡œë”© ë° ë Œë”ë§ ê¸°ëŠ¥
    async function loadAvailableTags() {
        try {
            const response = await fetch('/tags/api/');
            const result = await response.json();
            if (result.success) {
                renderTagContainer(result.tags);
                renderTagLegend(result.tags);
            } else {
                showTagError('íƒœê·¸ ë¡œë“œ ì‹¤íŒ¨: ' + result.message);
            }
        } catch (error) {
            showTagError('íƒœê·¸ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }
    
    function renderTagContainer(tags) {
        const tagContainer = document.getElementById('tagContainer');
        if (tags.length === 0) {
            tagContainer.innerHTML = `<div class="text-center py-2">
                <p class="text-muted small">íƒœê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.<br>'ìƒˆ íƒœê·¸' ë²„íŠ¼ìœ¼ë¡œ ì¶”ê°€í•˜ì„¸ìš”.</p>
            </div>`;
            return;
        }
        
        tagContainer.innerHTML = tags.map(tag => `
            <button class="btn btn-outline-secondary btn-sm tag-btn text-start" 
                    data-tag-id="${tag.id}"
                    onclick="selectTag(${tag.id}, '${tag.color}', '${tag.name}')">
                <span class="badge me-2" style="background-color: ${tag.color};">&nbsp;</span>
                ${tag.name}
                ${tag.is_default ? '<i class="fas fa-star text-warning ms-1" title="ê¸°ë³¸ íƒœê·¸"></i>' : ''}
            </button>
        `).join('');
    }
    
    function renderTagLegend(tags) {
        const tagLegend = document.getElementById('tagLegend');
        if (tags.length === 0) {
            tagLegend.innerHTML = '<small class="text-muted">ìƒì„±ëœ íƒœê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</small>';
            return;
        }
        tagLegend.innerHTML = tags.map(tag => `
            <span class="badge" style="background-color: ${tag.color};">${tag.name}</span>
        `).join('');
    }
    
    function showTagError(message) {
        const tagContainer = document.getElementById('tagContainer');
        tagContainer.innerHTML = `<div class="alert alert-danger p-2 small">${message}</div>`;
    }

    // `goToToday`ëŠ” `onclick`ì—ì„œ ì§ì ‘ í˜¸ì¶œë˜ë¯€ë¡œ ì „ì—­ ìŠ¤ì½”í”„ì— ë‘¡ë‹ˆë‹¤.
    window.goToToday = () => {
        const url = new URL(window.location);
        url.searchParams.delete('date');
        window.location.href = url.toString();
    };

</script>
{% endblock %} 